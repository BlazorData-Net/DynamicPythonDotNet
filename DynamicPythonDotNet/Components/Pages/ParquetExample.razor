@page "/parquet"
@inject IJSRuntime JSRuntime

@using System.Text.Json
@using System.Text.Json.Nodes
@using Radzen
@using SimpleBlazorMonaco
@using MonacoRazor

<h3>Parquet File Example</h3>

<InputFile OnChange="PickAndProcessFile"
           accept=".xls,.xlsx,.parquet" />
<br />
<CodeEditor @ref="@MonacoCodeEditor"
            Language="python"
            Code="@CurrentScript"
            Height="300px"
            Width="100%" />

<br />

<RadzenButton Text="Update Code"
              Click="UpdateCode"
              ButtonStyle="ButtonStyle.Secondary"
              Style="margin-right: 10px" />

<RadzenButton Text="Execute"
              Click="ExecutePython"
              ButtonStyle="ButtonStyle.Primary" />

@if (isRunning)
{
    <div style="text-align:center; margin:20px;">
        <div class="spinner-border text-primary" role="status"></div>
        <p>Running Python...</p>
    </div>
}

<br />

@if (!string.IsNullOrEmpty(Message))
{
    <div class="alert alert-danger">
        <strong>Error:</strong> @Message
    </div>
}

<br />

@if (dataRows?.Any() == true)
{
    <RadzenDataGrid Data="@dataRows" TItem="Dictionary<string, object>">
        <Columns>
            @foreach (var key in dataRows[0].Keys)
            {
                <RadzenDataGridColumn TItem="Dictionary<string, object>" Title="@key">
                    <Template Context="context">
                        @context[key]
                    </Template>
                </RadzenDataGridColumn>
            }
        </Columns>
    </RadzenDataGrid>
}

@code {
    CodeEditor? MonacoCodeEditor;
    private IBrowserFile CurrentFile;
    private string Message = "";
    bool isRunning = false;
    string CurrentScript = "";
    string SampleScript = @"
import pandas as pd

def load_data():
    df = pd.DataFrame([
        {'Name': 'Alice', 'Age': 30},
        {'Name': 'Bob', 'Age': 25}
    ])
    return df
";
    List<Dictionary<string, object>> dataRows = new();

    protected override void OnInitialized()
    {
        CurrentScript = SampleScript;
    }

    private async Task PickAndProcessFile(InputFileChangeEventArgs e)
    {

        try
        {
            if (e.File == null)
            {
                return;
            }

            CurrentFile = e.File;

            // Increase the max allowed size to a value larger than your file size
            using var fileStream = CurrentFile.OpenReadStream(maxAllowedSize: 50 * 1024 * 1024); // 50 MB

            System.Text.Encoding.RegisterProvider(System.Text.CodePagesEncodingProvider.Instance);

            using var memoryStream = new MemoryStream();
            await fileStream.CopyToAsync(memoryStream);
            memoryStream.Position = 0;
            var bytes = memoryStream.ToArray();

            // Convert to Base64 for JS interop
            var base64 = Convert.ToBase64String(bytes);

            // Write file into Pyodide FS
            await JSRuntime.InvokeVoidAsync("writeFileToPyodide", e.File.Name, base64);

            // Run Python to process and get result
            var json = await JSRuntime.InvokeAsync<string>("runPythonProcessing", e.File.Name);
            
            // Parse and flatten JSON into a table-friendly format
            dataRows = new List<Dictionary<string, object>>();
            var parsedArray = JsonNode.Parse(json)?.AsArray();

            if (parsedArray != null)
            {
                foreach (var item in parsedArray)
                {
                    var dict = new Dictionary<string, object>();
                    if (item is JsonObject obj)
                    {
                        foreach (var prop in obj)
                        {
                            dict[prop.Key] = prop.Value?.GetValue<object>() ?? "";
                        }
                    }
                    dataRows.Add(dict);
                }
            }
        }
        catch (Exception ex)
        {
            Message = $"Error: {ex.Message}";
        }
    }

    private async Task UpdateCode()
    {
        await MonacoCodeEditor.UpdateCodeAsync(SampleScript);
    }

    private void CloseMessagePopup()
    {
        Message = "";
    }

    private async Task ExecutePython()
    {
        try
        {
            Message = ""; // Clear any previous error messages

            isRunning = true;
            StateHasChanged();

            // Get Python code from Monaco
            var pythonCode = await MonacoCodeEditor.GetCodeAsync();

            // Call JS to execute Python via Pyodide and get JSON
            var json = await JSRuntime.InvokeAsync<string>("runPythonScript", pythonCode);

            // Parse and flatten JSON into a table-friendly format
            dataRows = new List<Dictionary<string, object>>();
            var parsedArray = JsonNode.Parse(json)?.AsArray();

            if (parsedArray != null)
            {
                foreach (var item in parsedArray)
                {
                    var dict = new Dictionary<string, object>();
                    if (item is JsonObject obj)
                    {
                        foreach (var prop in obj)
                        {
                            dict[prop.Key] = prop.Value?.GetValue<object>() ?? "";
                        }
                    }
                    dataRows.Add(dict);
                }
            }
        }
        catch (JSException jsEx)
        {
            // Check if the error message contains "Must return a DataFrame"
            if (jsEx.Message.Contains("Must return a DataFrame"))
            {
                // Display a custom error message
                Message = "The Python code must return a valid Pandas DataFrame. Please ensure your function returns a DataFrame.";
            }
            else
            {
                // Display the original error message for other errors
                Message = jsEx.Message;
            }
        }
        catch (Exception ex)
        {
            // Handle other errors
            Message = ex.Message;
        }
        finally
        {
            isRunning = false;
            StateHasChanged();
        }
    }
}