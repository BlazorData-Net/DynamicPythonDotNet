<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
    <title>DynamicPythonDotNet</title>
    <base href="/" />
    <link rel="stylesheet" href="css/bootstrap/bootstrap.min.css" />
    <link rel="stylesheet" href="_content/Radzen.Blazor/css/default.css" />
    <link rel="stylesheet" href="css/app.css" />
    <link rel="stylesheet" href="DynamicPythonDotNet.styles.css" />
    <link rel="icon" href="data:,">
</head>

<script src="https://cdn.jsdelivr.net/pyodide/v0.27.1/full/pyodide.js"></script>

<script>
    let pyodideReadyPromise = loadPyodide();

     /**
     * Decode a Base64 string into a Uint8Array.
     * @param {string} base64 - The Base64-encoded data.
     * @returns {Uint8Array} - The decoded byte array.
     */
    function base64ToUint8Array(base64) {
        // 1. Decode to a binary string
        const binaryString = window.atob(base64); // atob is widely supported 
        // 2. Allocate a byte array
        const len = binaryString.length;
        const bytes = new Uint8Array(len);      // Uint8Array is available in all modern JS 
        // 3. Populate with character codes (0â€“255)
        for (let i = 0; i < len; i++) {
            bytes[i] = binaryString.charCodeAt(i);
        }
        return bytes;
    }

    async function writeFileToPyodide(filename, base64Data) {
        const bytes = base64ToUint8Array(base64Data);
        const pyodide = await pyodideReadyPromise;
        pyodide.FS.writeFile(`/${filename}`, bytes, { encoding: 'binary' });
    }

    async function runPythonProcessing(filename) {
        const pyodide = await pyodideReadyPromise;

        // 1. Install engine
        await pyodide.loadPackage("micropip");
        await pyodide.loadPackage("pandas") 
        const micropip = pyodide.pyimport('micropip');
        await micropip.install('openpyxl');  

        // 2. Read into a DataFrame and serialize
        const df_json = pyodide.runPython(`
import pandas as pd
df = pd.read_excel('/${filename}')
df.to_json(orient='records')
`);
        console.log('Data:', JSON.parse(df_json));
        return df_json;
    }

    async function runPythonScript(pythonCode) {
    let pyodide = await pyodideReadyPromise;

    // Load the Pandas package
    await pyodide.loadPackage("pandas");

    // Import necessary modules
    pyodide.runPython(`import json`);

    try {
        // Execute the Python code
        pyodide.runPython(pythonCode + `
_result = load_data()
if not isinstance(_result, pd.DataFrame):
    raise TypeError("Must return a DataFrame")
_result_json = _result.to_json(orient="records")
`);

        // Retrieve the JSON result
        const resultJson = pyodide.globals.get('_result_json');
        return resultJson;
    } catch (error) {
        // Extract and throw only the relevant error message
        const errorMessage = error.message.split("\n").find(line => line.includes("TypeError: Must return a DataFrame"));
        throw new Error(errorMessage || "An error occurred while executing the Python code.");
    }
}
</script>

<body>

    <div class="status-bar-safe-area"></div>

    <div id="app">Loading...</div>

    <div id="blazor-error-ui">
        An unhandled error has occurred.
        <a href="" class="reload">Reload</a>
        <a class="dismiss">ðŸ—™</a>
    </div>

    <script src="_framework/blazor.webview.js" autostart="false"></script>
    <script src="_content/Radzen.Blazor/Radzen.Blazor.js"></script>

</body>

</html>